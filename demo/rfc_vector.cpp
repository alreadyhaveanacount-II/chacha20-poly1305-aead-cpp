#include <iostream>
#include <vector>
#include <benchmarking/benchmark.hpp>
#include <chacha20_poly1305.hpp>

void test_performance() {
    // For performance test

    Benchmarking::set_high_priority();
    Benchmarking::test_chacha20();
    Benchmarking::test_aead();
}

void rfc_test() {
    // For correctness test

    //
    // RFC 8439 Test Vector, Appendix A, Section 3
    //

    uint32_t key[8] = {
        0xa540921c,
        0x8ad355eb,
        0x868833f3,
        0xf0b5f604,
        0xc1173947,
        0x09802b40,
        0xbc5cca9d,
        0xc0757020
    };

    uint32_t nonce[3] = {
        0x00000000,
        0x04030201,
        0x08070605
    };

    std::vector<uint8_t> aad = {
        0xf3, 0x33, 0x88, 0x86,
        0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x4e, 0x91
    };

    std::vector<uint8_t> ciphertext = {
        0x64,0xa0,0x86,0x15,0x75,0x86,0x1a,0xf4,
        0x60,0xf0,0x62,0xc7,0x9b,0xe6,0x43,0xbd,
        0x5e,0x80,0x5c,0xfd,0x34,0x5c,0xf3,0x89,
        0xf1,0x08,0x67,0x0a,0xc7,0x6c,0x8c,0xb2,
        0x4c,0x6c,0xfc,0x18,0x75,0x5d,0x43,0xee,
        0xa0,0x9e,0xe9,0x4e,0x38,0x2d,0x26,0xb0,
        0xbd,0xb7,0xb7,0x3c,0x32,0x1b,0x01,0x00,
        0xd4,0xf0,0x3b,0x7f,0x35,0x58,0x94,0xcf,
        0x33,0x2f,0x83,0x0e,0x71,0x0b,0x97,0xce,
        0x98,0xc8,0xa8,0x4a,0xbd,0x0b,0x94,0x81,
        0x14,0xad,0x17,0x6e,0x00,0x8d,0x33,0xbd,
        0x60,0xf9,0x82,0xb1,0xff,0x37,0xc8,0x55,
        0x97,0x97,0xa0,0x6e,0xf4,0xf0,0xef,0x61,
        0xc1,0x86,0x32,0x4e,0x2b,0x35,0x06,0x38,
        0x36,0x06,0x90,0x7b,0x6a,0x7c,0x02,0xb0,
        0xf9,0xf6,0x15,0x7b,0x53,0xc8,0x67,0xe4,
        0xb9,0x16,0x6c,0x76,0x7b,0x80,0x4d,0x46,
        0xa5,0x9b,0x52,0x16,0xcd,0xe7,0xa4,0xe9,
        0x90,0x40,0xc5,0xa4,0x04,0x33,0x22,0x5e,
        0xe2,0x82,0xa1,0xb0,0xa0,0x6c,0x52,0x3e,
        0xaf,0x45,0x34,0xd7,0xf8,0x3f,0xa1,0x15,
        0x5b,0x00,0x47,0x71,0x8c,0xbc,0x54,0x6a,
        0x0d,0x07,0x2b,0x04,0xb3,0x56,0x4e,0xea,
        0x1b,0x42,0x22,0x73,0xf5,0x48,0x27,0x1a,
        0x0b,0xb2,0x31,0x60,0x53,0xfa,0x76,0x99,
        0x19,0x55,0xeb,0xd6,0x31,0x59,0x43,0x4e,
        0xce,0xbb,0x4e,0x46,0x6d,0xae,0x5a,0x10,
        0x73,0xa6,0x72,0x76,0x27,0x09,0x7a,0x10,
        0x49,0xe6,0x17,0xd9,0x1d,0x36,0x10,0x94,
        0xfa,0x68,0xf0,0xff,0x77,0x98,0x71,0x30,
        0x30,0x5b,0xea,0xba,0x2e,0xda,0x04,0xdf,
        0x99,0x7b,0x71,0x4d,0x6c,0x6f,0x2c,0x29,
        0xa6,0xad,0x5c,0xb4,0x02,0x2b,0x02,0x70,
        0x9b
    };

    std::vector<uint8_t> expected_plaintext = {
        0x49,0x6e,0x74,0x65,0x72,0x6e,0x65,0x74,
        0x2d,0x44,0x72,0x61,0x66,0x74,0x73,0x20,
        0x61,0x72,0x65,0x20,0x64,0x72,0x61,0x66,
        0x74,0x20,0x64,0x6f,0x63,0x75,0x6d,0x65,
        0x6e,0x74,0x73,0x20,0x76,0x61,0x6c,0x69,
        0x64,0x20,0x66,0x6f,0x72,0x20,0x61,0x20,
        0x6d,0x61,0x78,0x69,0x6d,0x75,0x6d,0x20,
        0x6f,0x66,0x20,0x73,0x69,0x78,0x20,0x6d,
        0x6f,0x6e,0x74,0x68,0x73,0x20,0x61,0x6e,
        0x64,0x20,0x6d,0x61,0x79,0x20,0x62,0x65,
        0x20,0x75,0x70,0x64,0x61,0x74,0x65,0x64,
        0x2c,0x20,0x72,0x65,0x70,0x6c,0x61,0x63,
        0x65,0x64,0x2c,0x20,0x6f,0x72,0x20,0x6f,
        0x62,0x73,0x6f,0x6c,0x65,0x74,0x65,0x64,
        0x20,0x62,0x79,0x20,0x6f,0x74,0x68,0x65,
        0x72,0x20,0x64,0x6f,0x63,0x75,0x6d,0x65,
        0x6e,0x74,0x73,0x20,0x61,0x74,0x20,0x61,
        0x6e,0x79,0x20,0x74,0x69,0x6d,0x65,0x2e,
        0x20,0x49,0x74,0x20,0x69,0x73,0x20,0x69,
        0x6e,0x61,0x70,0x70,0x72,0x6f,0x70,0x72,
        0x69,0x61,0x74,0x65,0x20,0x74,0x6f,0x20,
        0x75,0x73,0x65,0x20,0x49,0x6e,0x74,0x65,
        0x72,0x6e,0x65,0x74,0x2d,0x44,0x72,0x61,
        0x66,0x74,0x73,0x20,0x61,0x73,0x20,0x72,
        0x65,0x66,0x65,0x72,0x65,0x6e,0x63,0x65,
        0x20,0x6d,0x61,0x74,0x65,0x72,0x69,0x61,
        0x6c,0x20,0x6f,0x72,0x20,0x74,0x6f,0x20,
        0x63,0x69,0x74,0x65,0x20,0x74,0x68,0x65,
        0x6d,0x20,0x6f,0x74,0x68,0x65,0x72,0x20,
        0x74,0x68,0x61,0x6e,0x20,0x61,0x73,0x20,
        0x2f,0xe2,0x80,0x9c,0x77,0x6f,0x72,0x6b,
        0x20,0x69,0x6e,0x20,0x70,0x72,0x6f,0x67,
        0x72,0x65,0x73,0x73,0x2e,0x2f,0xe2,0x80,
        0x9d
    };

    uint8_t tag[16] = {
        0xee,0xad,0x9d,0x67,
        0x89,0x0c,0xbb,0x22,
        0x39,0x23,0x36,0xfe,
        0xa1,0x85,0x1f,0x38
    };

    ChaCha20 c(key, nonce);

    std::vector<uint8_t> output(ciphertext.size());

    try {
        ChaCha20_Poly1305::decrypt(c, ciphertext.data(), ciphertext.size(), aad.data(), aad.size(), tag, output.data());
    }
    catch (const std::exception& e) {
        std::cout << "Poly1305 generated tag is not matching RFC Test Vector";
    }

    if (output != expected_plaintext) {
        throw std::runtime_error("ChaCha20 result is not matching RFC Test Vector");
    }

    std::cout << "Everything working just fine";
}

int main(int argc, char* argv[]) {
    // rfc_test(); // uncomment for correctness test
    test_performance(); // simple performance test

    std::cout << "\nPress any key to exit..." << std::endl;
    std::cin.get();
    return 0;
}
